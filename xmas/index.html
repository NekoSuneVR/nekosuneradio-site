<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NekoSune Community - üéÑ Christmas Radio üé∂</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Social / OG -->
  <meta name="twitter:card" content="player">
  <meta name="twitter:site" content="@nekosunevr">
  <meta name="twitter:player" content="https://widgets.nekosunevr.co.uk/radiochannels/index.html">
  <meta name="twitter:player:width" content="100">
  <meta name="twitter:player:height" content="160">
  <meta name="twitter:image" content="https://upload.wikimedia.org/wikipedia/commons/thumb/3/39/Christmas_tree_icon.png/640px-Christmas_tree_icon.png">

  <meta property="og:title" content="üéÑ NekoSune Christmas Radio - Holiday Mixes" />
  <meta property="og:description" content="Cozy up for holly-jolly tunes ‚Äî NekoSune Community Radio in Christmas mode!" />
  <meta property="og:image" content="https://upload.wikimedia.org/wikipedia/commons/thumb/3/39/Christmas_tree_icon.png/640px-Christmas_tree_icon.png" />
  <meta property="og:url" content="https://widgets.nekosunevr.co.uk/radiochannels/" />
  <meta property="og:audio" content="https://icy.nekosunevr.co.uk/nekosunecommunity.mp3" />
  <meta property="og:audio:type" content="audio/mp3" />
  <meta property="og:audio:secure_url" content="https://icy.nekosunevr.co.uk/nekosunecommunity.mp3" />

  <script src="https://cdn.tailwindcss.com"></script>

  <link href="https://fonts.googleapis.com/css2?family=Mountains+of+Christmas:wght@400;700&family=Nunito:wght@300;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --christmas-red:#c62828;
      --christmas-green:#2e7d32;
      --gold:#f6c453;
      --bg:#07121a;
      --card:#08202a;
    }

    body{
      margin:0;
      font-family: 'Nunito', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg, #07121a 0%, #071827 50%, #04121a 100%);
      color: #fff;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:2rem;
      overflow:hidden;
    }

    /* layout */
    .container{ max-width:1100px; width:100%; display:grid; grid-template-columns: 1fr 2fr; gap:1.25rem; align-items:start; }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(0,0,0,0.06));
      border-radius:1rem;
      padding:1.25rem;
      box-shadow: 0 8px 30px rgba(2,6,23,0.6);
      border: 1px solid rgba(255,255,255,0.03);
    }

    /* ornament / disc */
    .ornament{
      width:16rem;
      height:16rem;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,0.06), rgba(0,0,0,0.10));
      position:relative;
      border:6px solid rgba(246,196,83,0.10);
      box-shadow: 0 12px 40px rgba(2,6,23,0.7), inset 0 -15px 40px rgba(0,0,0,0.4);
    }

    .ornament .inner{
      width:92%;
      height:92%;
      border-radius:50%;
      overflow:hidden;
      border:5px solid rgba(255,255,255,0.02);
    }

    .ornament.playing{ animation: spin 5s linear infinite; }
    .ornament.paused{ animation-play-state: paused; }
    @keyframes spin { from { transform: rotate(0deg);} to { transform: rotate(360deg);} }

    .ornament-top{
      position:absolute;
      top:-18px;
      width:60px;
      height:30px;
      left:calc(50% - 30px);
      background: linear-gradient(180deg, var(--gold), #bd8a2f);
      border-radius:6px 6px 12px 12px;
      box-shadow: inset 0 -3px 8px rgba(0,0,0,0.25);
    }

    /* twinkling lights header */
    .lights {
      display:flex;
      gap:6px;
      padding:0.5rem;
      justify-content:center;
      margin-bottom:0.5rem;
    }
    .bulb{
      width:12px;height:12px;border-radius:50%;
      box-shadow: 0 0 8px rgba(0,0,0,0.3);
      animation: blink 3s infinite;
      opacity:0.95;
    }
    .b-red{ background:var(--christmas-red); animation-delay:0s; }
    .b-green{ background:var(--christmas-green); animation-delay:0.4s; }
    .b-gold{ background:var(--gold); animation-delay:0.8s; }
    @keyframes blink {
      0%, 50%, 100%{ transform:scale(1); filter:brightness(1); }
      25%{ transform:scale(1.25); filter:brightness(1.8); }
      75%{ transform:scale(0.95); filter:brightness(0.8); }
    }

    h1.title{
      font-family: 'Mountains of Christmas', cursive;
      font-size:1.5rem;
      margin:0;
      color:var(--gold);
      text-shadow: 0 2px 8px rgba(0,0,0,0.6);
    }

    .meta{ color: rgba(255,255,255,0.75); font-size:0.95rem; margin-top:0.25rem; }

    /* snow */
    .snowflake{
      position:fixed;
      top:-10%;
      pointer-events:none;
      font-size:1.15rem;
      opacity:0.95;
      animation: fall linear infinite;
      filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3));
    }
    @keyframes fall {
      to { transform: translateY(120vh) rotate(360deg); }
    }

    /* controls */
    .controls{ display:flex; gap:0.5rem; align-items:center; margin-top:0.75rem; }
    .btn{
      padding:0.5rem 0.9rem; border-radius:0.65rem; font-weight:700; cursor:pointer; border: none;
    }
    .btn-play{ background: linear-gradient(90deg, var(--christmas-red), #ff6f61); color:white; }
    .btn-play:hover{ filter:brightness(1.05); }

    .btn-jingle{ background: linear-gradient(90deg, #2e7d32, #1b5e20); color:white; }

    input[type=range] { accent-color: var(--gold); }

    /* song list */
    .song-card{ display:flex; gap:0.75rem; align-items:center; background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.06)); padding:0.6rem; border-radius:0.7rem; border:1px solid rgba(255,255,255,0.03); }
    .song-cover{ width:48px; height:48px; border-radius:8px; object-fit:cover; }

    /* responsive */
    @media (max-width:820px){
      .container{ grid-template-columns: 1fr; }
      .ornament{ width:12rem; height:12rem; }
    }
  </style>
</head>
<body>
  <!-- falling snow generated by JS (accessible emoji snow fallback) -->
  <div class="container">
    <!-- LEFT: ornament + player -->
    <div class="card" style="display:flex;flex-direction:column;align-items:center;gap:1rem;">
      <div class="lights" aria-hidden="true">
        <div class="bulb b-red"></div>
        <div class="bulb b-green"></div>
        <div class="bulb b-gold"></div>
        <div class="bulb b-red"></div>
        <div class="bulb b-green"></div>
      </div>

      <div class="ornament" id="ornament">
        <div class="ornament-top" aria-hidden="true"></div>
        <div class="inner">
          <img id="coverArt" src="https://placehold.co/400x400?text=Christmas+Cover" alt="cover" style="width:100%;height:100%;object-fit:cover;" />
        </div>
      </div>

      <div style="text-align:center;">
        <h1 class="title">NekoSune Holiday Radio</h1>
        <div class="meta" id="djStatus">Warm cocoa & chill beats</div>
      </div>

      <div class="controls" style="width:100%; justify-content:center;">
        <button id="playBtn" class="btn btn-play">Play</button>
        <input id="volume" type="range" min="0" max="1" step="0.01" value="0.5" style="width:160px;">
        <button id="jingleToggle" class="btn btn-jingle" title="Toggle ambient jingle">Toggle Jingle</button>
      </div>

      <audio id="player" src="https://icy.nekosunevr.co.uk/nekosunecommunity.mp3"></audio>
      <!-- optional jingle (not autoplay) -->
      <audio id="jingle" src="" preload="none"></audio>
    </div>

    <!-- RIGHT: info and requests -->
    <div class="card" style="display:flex;flex-direction:column;gap:1rem;">
      <div>
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <h2 style="margin:0;font-family:'Mountains of Christmas',cursive;font-size:1.25rem;color:var(--gold);">Your Station ‚Äî üéÑ</h2>
            <div class="meta" id="nowPlaying">Fetching what's playing‚Ä¶</div>
          </div>
          <div style="text-align:right;">
            <div class="meta">Now: <strong id="songTitle">Loading...</strong></div>
            <div class="meta" id="songArtist">Please wait</div>
          </div>
        </div>
      </div>

      <div>
        <h3 style="margin:0 0 0.5rem 0;font-weight:700;">On Air DJs</h3>
        <div class="meta" id="djList">Loading DJs...</div>
      </div>

      <div>
        <h3 style="margin:0 0 0.5rem 0;font-weight:700;">Request a Song</h3>
        <details style="background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.04)); padding:0.5rem; border-radius:0.6rem;">
          <summary style="cursor:pointer;padding:0.4rem 0.6rem;border-radius:0.45rem;background:rgba(255,255,255,0.02);">Available Songs (click)</summary>
          <div id="songs" style="margin-top:0.6rem; display:grid; gap:0.6rem; max-height:320px; overflow:auto;"></div>
        </details>
      </div>

      <div style="margin-top:auto; display:flex; gap:0.75rem; justify-content:flex-end; align-items:center;">
        <div class="meta">Theme: <strong>Christmas</strong></div>
        <div style="font-size:1.2rem;">üéÅ ‚ùÑÔ∏è</div>
      </div>
    </div>
  </div>

  <script>
    // elements
    const player = document.getElementById('player');
    const playBtn = document.getElementById('playBtn');
    const jingleToggle = document.getElementById('jingleToggle');
    const jingle = document.getElementById('jingle');
    const volume = document.getElementById('volume');
    const ornament = document.getElementById('ornament');

    // set jingle source (you can set your own jingle url here)
    // keep empty by default to avoid auto-download; replace with URL if you host a file
    jingle.src = ""; // e.g. "https://example.com/xmas-jingle.mp3"

    // Play/pause
    playBtn.addEventListener('click', () => {
      if (player.paused) {
        player.play().catch(()=>{ /* playback blocked by browser */ });
        ornament.classList.add('playing');
        playBtn.textContent = 'Pause';
      } else {
        player.pause();
        ornament.classList.remove('playing');
        playBtn.textContent = 'Play';
      }
    });

    volume.addEventListener('input', e => { player.volume = e.target.value; });

    // Jingle toggle ‚Äî play short jingle once when enabled (if src set)
    let jingleEnabled = false;
    jingleToggle.addEventListener('click', () => {
      jingleEnabled = !jingleEnabled;
      jingleToggle.style.opacity = jingleEnabled ? '1' : '0.85';
      if (jingleEnabled && jingle.src) {
        jingle.currentTime = 0;
        jingle.play().catch(()=>{ /* suppressed */ });
      } else if (!jingleEnabled) {
        jingle.pause();
      }
    });

    // update og image helper
    function updateImageURL(songURL) {
      const og = document.querySelector('meta[property="og:image"]');
      const tw = document.querySelector('meta[name="twitter:image"]');
      if (og) og.setAttribute('content', songURL);
      if (tw) tw.setAttribute('content', songURL);
    }

    // fetch now playing (uses your existing api.php)
    async function fetchData(){
      try{
        const res = await fetch('api.php?action=nowplaying');
        const data = await res.json();
        document.getElementById('songTitle').textContent = data.title || 'Unknown';
        document.getElementById('songArtist').textContent = data.artist || 'Unknown';
        document.getElementById('nowPlaying').textContent = `${data.title || '‚Äî'} ‚Äî ${data.artist || '‚Äî'}`;
        document.getElementById('djList').textContent = data.djs && data.djs.length ? data.djs.join(', ') : 'No DJs live right now.';
        const art = data.art || 'https://placehold.co/400x400?text=Christmas+Cover';
        document.getElementById('coverArt').src = art;
        document.title = `üéÑ NekoSune Christmas Radio: ${data.artist || '‚Äî'} - ${data.title || '‚Äî'}`;
        updateImageURL(art);
      }catch(e){
        console.warn('Nowplaying fetch failed', e);
      }
    }

    setInterval(fetchData, 3000);
    fetchData();

    // load songs list
    async function loadSongs(){
      try{
        const res = await fetch('api.php?action=list');
        const songs = await res.json();
        const container = document.getElementById('songs');
        container.innerHTML = '';
        (songs || []).forEach(song=>{
          const html = `
            <div class="song-card">
              <img class="song-cover" src="${song.song.art || 'https://placehold.co/100x100?text=Song'}" alt="cover">
              <div style="flex:1;">
                <div style="font-weight:700;">${song.song.title}</div>
                <div style="font-size:0.85rem;color:rgba(255,255,255,0.75)">${song.song.artist || ''}</div>
              </div>
              <button class="btn btn-play" onclick="requestSong('${song.request_id}')">Request</button>
            </div>
          `;
          container.insertAdjacentHTML('beforeend', html);
        });
      }catch(e){
        console.warn('Load songs failed', e);
      }
    }
    loadSongs();

    async function requestSong(id){
      try{
        const res = await fetch('api.php?action=request', { method:'POST', body: new URLSearchParams({ request_id: id })});
        const data = await res.json();
        alert(data.message || 'Request sent!');
      }catch(e){
        alert('Request failed');
      }
    }

    // falling snow generator (accessible fallback: uses unicode snowflake)
    function spawnSnowflake(){
      const flake = document.createElement('div');
      flake.className = 'snowflake';
      flake.style.left = Math.random()*100 + 'vw';
      const size = 10 + Math.random()*18;
      flake.style.fontSize = size + 'px';
      flake.style.opacity = 0.6 + Math.random()*0.6;
      const duration = 8 + Math.random()*12;
      flake.style.animationDuration = duration + 's';
      // choose emoji gentle snow or star
      const choices = ['‚ùÑÔ∏è','‚ùÖ','‚ú∂','‚úª'];
      flake.textContent = choices[Math.floor(Math.random()*choices.length)];
      document.body.appendChild(flake);
      setTimeout(()=> flake.remove(), duration*1000 + 500);
    }

    // spawn a few continuously, but modest amount so CPU stays low
    setInterval(spawnSnowflake, 600);
    for(let i=0;i<12;i++) setTimeout(spawnSnowflake, i*300);

    // keyboard space to toggle play (nice little accessibility)
    document.addEventListener('keydown', (e)=>{
      if(e.code === 'Space' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA'){
        e.preventDefault();
        playBtn.click();
      }
    });

    // expose requestSong to global as used in inline onclick
    window.requestSong = requestSong;
  </script>
</body>
</html>
